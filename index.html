<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
	<meta charset="utf-8">
	<title>Fluid</title>
	<meta name="viewport"
		  content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0" />
	<style>
		:root {
			--highlight-color: hsl(227, 90%, 76%);
			--select-border: #777;
			--select-focus: var(--highlight-color);
			--select-arrow: var(--select-border);
		}

		*,
		*::before,
		*::after {
			box-sizing: border-box;
		}

		* {
			margin: 0;
			padding: 0;
		}

		/* inter-regular - latin */
		@font-face {
			font-display: swap;
			font-family: 'Inter';
			font-style: normal;
			font-weight: 400;
			src: url('/assets/fonts/inter-v12-latin-regular.woff2') format('woff2');
		}

		/* inter-700 - latin */
		@font-face {
			font-display: swap;
			font-family: 'Inter';
			font-style: normal;
			font-weight: 700;
			src: url('/assets/fonts/inter-v12-latin-700.woff2') format('woff2');
		}

		html,
		body {
			min-height: 100dvh;
			font-family: "Inter", sans-serif;
		}

		body {
			background-image: linear-gradient(114.02deg, #A74FEC 4.94%, #5F6CFA 53.23%, #8CA4F9 93.25%);
			background-image: linear-gradient(114.02deg in oklch, oklch(61.1% 0.229 306.48) 4.94%, oklch(60.01% 0.209 274.26) 53.23%, oklch(73.51% 0.126 271.04) 93.25%);
			padding: 1rem;
			color: #262729;
		}

		nav {
			display: flex;
			flex-wrap: wrap;
			gap: 1rem;
		}

		button {
			border: none;
			cursor: pointer;
			transition: color .25ms ease;
			background-color: transparent;
		}

		.open-button {
			border: 1px solid hsl(0, 0%, 100%);
			border-radius: 4px;
			padding: .5rem 1rem;
			transition: border .25s ease;
			color: #fff;
		}

		.open-button:disabled {
			opacity: .5;
			cursor: not-allowed;
		}

		.open-button:hover {
			border: 1px solid hsla(0, 0%, 100%, .8);
		}

		.trigger-close-settings {
			line-height: 1;
			font-size: 26px;
			color: hsla(0, 0%, 0%, 1);
		}

		.trigger-close-settings:hover {
			color: hsla(0, 0%, 0%, .5);
		}

		.trigger-settings {
			color: hsla(0, 0%, 100%, .8);
			margin-block-end: 1rem;
		}

		.trigger-settings:hover {
			color: hsla(0, 0%, 100%, 1);
		}

		.trigger-settings svg {
			width: 1.5rem;
			height: 1.5rem;
			width: 1rem;
			height: 1rem;
		}

		.settings {
			transform: translate3d(-1rem, -110%, 0);
			transition: transform 0.3s linear;
			position: fixed;
			z-index: 1;
			inset-block-start: 0;
			border-radius: 0 0 4px 4px;
			padding: 1em;
			inline-size: max-content;
			background-color: #fff;
			--shadow-color: 227deg 90% 76%;
			box-shadow: 0.3px 0.5px 0.7px hsl(var(--shadow-color) / 0.36),
				0.8px 1.6px 2px -0.8px hsl(var(--shadow-color) / 0.36),
				2.1px 4.1px 5.2px -1.7px hsl(var(--shadow-color) / 0.36),
				5px 10px 12.6px -2.5px hsl(var(--shadow-color) / 0.36);
		}

		.settings.is-active {
			transform: translate3d(-1rem, 0, 0);
		}

		.settings-backdrop {
			display: none;
		}

		.settings-backdrop.is-active {
			display: block;
			inline-size: 100%;
			block-size: 100%;
			position: fixed;
			inset: 0;
			z-index: 0;
		}

		.hint {
			margin-block-end: 0.75rem;
			font-size: 0.75rem;
		}

		.hint a {
			color: inherit;
		}

		label {
			font-size: 0.75rem;
			display: block;
			margin-block: .75rem .25rem;
		}

		select {
			appearance: none;
			background-color: transparent;
			border: none;
			padding: 0 1em 0 0;
			margin: 0;
			width: 100%;
			font-family: inherit;
			font-size: 0.75rem;
			cursor: inherit;
			line-height: inherit;
			z-index: 1;
			outline: none;
			color: #262729;
		}

		.select {
			display: grid;
			grid-template-areas: "select";
			align-items: center;
			position: relative;
			min-width: 15ch;
			max-width: 30ch;
			border: 1px solid var(--select-border);
			border-radius: 0.25em;
			padding: 0.25em 0.5em;
			font-size: 1.25rem;
			cursor: pointer;
			line-height: 1.1;
			background-color: #fff;
			background-image: linear-gradient(to top, #f9f9f9, #fff 33%);
		}

		.select:not(.select--multiple)::after {
			content: "";
			justify-self: end;
			width: 0.8em;
			height: 0.5em;
			background-color: var(--select-arrow);
			clip-path: polygon(100% 0%, 0 0%, 50% 100%);
		}

		select,
		.select::after {
			grid-area: select;
		}

		select:focus+.focus {
			position: absolute;
			top: -1px;
			left: -1px;
			right: -1px;
			bottom: -1px;
			border: 2px solid var(--select-focus);
			border-radius: inherit;
		}

		.qr-space {
			display: none;
			justify-content: center;
			align-items: center;
			margin-top: 1rem;
			width: 100%;
			height: 80vh;
		}

		.qr-space--visible {
			display: flex;
		}

		.qr {
			width: 20%;
		}

		@media only screen and (max-width: 480px) {
			.qr {
				width: 80%;
			}
		}
	</style>
	<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
</head>

<body>
	<button type="button" class="trigger-settings" onclick="displaySettings()">
		<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"
			 aria-label="Open the settings">
			<title>cog</title>
			<path d="M29.181 19.070c-1.679-2.908-0.669-6.634 2.255-8.328l-3.145-5.447c-0.898 0.527-1.943 0.829-3.058 0.829-3.361 0-6.085-2.742-6.085-6.125h-6.289c0.008 1.044-0.252 2.103-0.811 3.070-1.679 2.908-5.411 3.897-8.339 2.211l-3.144 5.447c0.905 0.515 1.689 1.268 2.246 2.234 1.676 2.903 0.672 6.623-2.241 8.319l3.145 5.447c0.895-0.522 1.935-0.82 3.044-0.82 3.35 0 6.067 2.725 6.084 6.092h6.289c-0.003-1.034 0.259-2.080 0.811-3.038 1.676-2.903 5.399-3.894 8.325-2.219l3.145-5.447c-0.899-0.515-1.678-1.266-2.232-2.226zM16 22.479c-3.578 0-6.479-2.901-6.479-6.479s2.901-6.479 6.479-6.479c3.578 0 6.479 2.901 6.479 6.479s-2.901 6.479-6.479 6.479z"
				  fill="currentcolor"></path>
		</svg>
	</button>

	<nav>
		<button type="button" class="open-button needs-init" onclick="openWallet('deposit')">Deposit</button>
		<button type="button" class="open-button needs-init" onclick="openWallet('quick-deposit')">Quick Deposit</button>
		<button type="button" class="open-button needs-init" onclick="openWallet('withdrawal')">Withdrawal</button>
		<button type="button" class="open-button" onclick="revealQR()">Try it elsewhere</button>
		<a href="./fluid-integration-manual/index.html"><button type="button" class="open-button">Integration Manual</button></a>
	</nav>

	<div class="settings">
		<button type="button" class="trigger-close-settings" onclick="displaySettings()">×</button>

		<label for="operatorSelect">Operator:</label>
		<div class="select">
			<select id="operatorSelect">
				<option value="10000001">Fluid Payments</option>
				<option value="100425990">Highroller</option>
			</select>
			<span class="focus"></span>
		</div>

		<div id="userSelectionArea">
			<label for="userSelect">Operation status:</label>
			<div class="select">
				<select id="userSelect"></select>
			</div>
		</div>

		<label for="locale">Locale:</label>
		<div class="select">
			<select id="locale">
				<option value="en">English</option>
				<option value="en-CA">Canadian English</option>
				<option value="en-NZ">New Zealand English</option>
				<option value="nb-NO">Norwegian Bokmål</option>
			<option value="ar">عربي</option>
				</select>
			<span class="focus"></span>
		</div>

		<label for="currency">Currency:</label>
		<div class="select">
			<select id="currency">
				<option value="EUR">Euro</option>
				<option value="NZD">Kiwi dollar</option>
				<option value="CAD">Canadian dollar</option>
				<option value="NOK">Norwegian korona</option>
			</select>
			<span class="focus"></span>
		</div>

		<label for="dir">Direction:</label>
		<div class="select">
			<select id="dir">
				<option value="ltr">Left to right</option>
				<option value="rtl">Right to left</option>
			</select>
			<span class="focus"></span>
		</div>
	</div>

	<div class="settings-backdrop" onclick="displaySettings()"></div>

	<!-- NOTE: in real-life scenario this block is added to DOM / injected on user login, with session-id provided -->
	<script type="module" src="https://getfluid.vercel.app/index.js"></script>
	<fluid-widget
		id="fluid-widget"
		operator-id=10000001
		user-id="10001"
		session-id=""
		locale="en"
		currency="EUR"
		transaction="deposit"
		open="false"
		balance="100"
		withdrawable-balance="20">
	</fluid-widget>

	<script>
		setOpenButtonsEnabled(false);

		listen();
		setDirAttribute();

		getSessionId();
		setInterval(getSessionId, 60 * 1000);

		function listen() {
			const fluid = document.querySelector('fluid-widget');

			if (!fluid) {
				return setTimeout(listen, 100);
			}

			// instead of "onevent", this is less convenient although recommended way of handling events
			// https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Building_blocks/Events#inline_event_handlers_%E2%80%94_dont_use_these
			fluid.addEventListener('fluid-command', onFluidCommand);
			fluid.addEventListener('fluid-info', onFluidInfo);
			fluid.addEventListener('fluid-error', onFluidError);

			const localeSelect = document.querySelector("#locale");
			localeSelect.addEventListener('change', (event) => {
				setOpenButtonsEnabled(false);
				fluid.setAttribute('locale', event.target.value);
			})

			const currencySelect = document.querySelector("#currency");
			currencySelect.addEventListener('change', (event) => {
				setOpenButtonsEnabled(false);
				fluid.setAttribute('currency', event.target.value);
			})

			const userSelect = document.querySelector("#userSelect");
			userSelect.addEventListener('change', (event) => {
				fluid.setAttribute('user-id', event.target.value);
			})

			const dirSelect = document.querySelector("#dir");
			dirSelect.addEventListener('change', (event) => {
				document.documentElement.setAttribute('dir', event.target.value);
				setDirAttribute();
			})

			const operatorSelect = document.querySelector("#operatorSelect");
			operatorSelect.addEventListener('change', (event) => {
				setOpenButtonsEnabled(false);
				const userSelectionArea = document.querySelector("#userSelectionArea");
				fluid.setAttribute('operator-id', event.target.value);
				if (event.target.value === '10000001') {
					fluid.setAttribute('user-id', '10001');
					userSelectionArea.style.display = "block";
				}
				else {
					fluid.setAttribute('user-id', '706761683811689');
					userSelectionArea.style.display = "none";
				}
			})
		}

		function openWallet(operation) {
			const fluid = document.querySelector('fluid-widget');

			fluid.setAttribute('transaction', operation);
			fluid.setAttribute('open', 'true');
		}

		function onFluidCommand(command) {
			console.info(`%cFLUID command: ${command.detail}`, 'color: green');
			switch (command.detail) {
				case 'close':
					const fluid = document.querySelector('fluid-widget');
					fluid.setAttribute('open', 'false');
					break;
				default:
					console.warn('unknown command received');
			}
		}

		function onFluidInfo(info) {
			console.info(`%cFLUID info: ${info.detail}`, 'color: blue');
			switch (info.detail) {
				case 'initialised':
					setOpenButtonsEnabled(true);
					break;
			}
		}

		function onFluidError(error) {
			switch (error.detail) {
				case 'initialisation-failure':
					console.info(`%cFLUID error: ${error.detail}`, 'color: red');
					break;
				default:
					console.info(`%cFLUID error: ${error.detail}`, 'color: orange');
					break;
			}
		}

		async function getSessionId() {
			const getSessionIdUrl = 'https://stage-highroller.uatsecure.com/ajax/token/getToken?token=cashier';
			const response = await fetch(getSessionIdUrl, {
				method: 'GET',
				credentials: 'include'
			});
			const result = await response.json()
			const fluidWidget = document.getElementById('fluid-widget');
			console.log('fetched sessionId:', result.token);
			fluidWidget.setAttribute('session-id', result.token);
		}

		let users = [];
		const urlParams = new URLSearchParams(window.location.search);
		const userId = urlParams.get('user-id');

		async function getUsers() {
			const usersUrl = 'https://fluid-payments.vercel.app/users';
			// const usersUrl = 'https://local.payments.com:9669/users';
			const response = await fetch(usersUrl);
			users = await response.json();

			const userSelect = document.querySelector('#userSelect');

			users.forEach((user) => {
				const option = document.createElement('option');
				option.value = user.userId;
				option.text = user.info;
				option.selected = user.userId === userId;
				userSelect.appendChild(option);
			});
		}
		getUsers();

		function revealQR() {
			document.querySelector('.qr-space').classList.toggle('qr-space--visible');
		}

		async function getUserData() {
			const userDataUrl = 'https://stage-highroller.uatsecure.com/ajax/profile/getData';
			const response = await fetch(userDataUrl, {
				method: 'GET',
				credentials: 'include'
			});
			const result = await response.json()
			const fluidWidget = document.getElementById('fluid-widget');
			console.log('balanceDetails:', result.balanceDetails);
			if (result && result.balanceDetails) {
				fluidWidget.setAttribute('balance', result.balanceDetails.cash);
				fluidWidget.setAttribute('withdrawable-balance', result.balanceDetails.withdrawableBalance);
			}
		}
		getUserData();

		function displaySettings() {
			document.querySelector('.settings').classList.toggle('is-active');
			document.querySelector('.settings-backdrop').classList.toggle('is-active');
		}

		function setDirAttribute() {
			const fluidWidget = document.getElementById('fluid-widget');
			fluidWidget.setAttribute('language-direction', document.documentElement.dir);
		}

		function setOpenButtonsEnabled(enabled) {
			const needInit = document.getElementsByClassName('needs-init');
			(Array.from(needInit)).forEach((element) => {
				element.disabled = !enabled;
			});
		}
	</script>

	<div class="qr-space">
		<img class="qr" src="fluidqr.png" alt="qr-code">
	</div>

</body>

</html>
